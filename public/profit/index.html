<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>売上管理 | 学部祭</title>

  <!-- Firebase (Realtime Database only) -->
  <script defer src="/__/firebase/12.4.0/firebase-app-compat.js"></script>
  <script defer src="/__/firebase/12.4.0/firebase-database-compat.js"></script>
  <!-- エミュレータ使用時は ?useEmulator=true、本番では外す -->
  <script defer src="/__/firebase/init.js?useEmulator=true"></script>

  <!-- フォント -->
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fff7ed; --paper:#ffffff; --ink:#3f2817; --ring:#e2c9a4;
      --accent:#ff914d; --muted:#8b5e34; --ok:#18a957; --danger:#e23d3d;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:"M PLUS Rounded 1c", system-ui, sans-serif;
      line-height:1.6; padding:20px;
    }
    .wrap{width:min(880px,100%); margin:0 auto; display:grid; gap:18px}
    .card{background:var(--paper); border:2px solid var(--ring); border-radius:22px; padding:18px}
    h1{margin:0 0 6px; font-weight:900}
    h2{margin:0 0 10px; font-weight:900}
    .muted{color:var(--muted)}
    .stamp{font-variant-numeric:tabular-nums}
    #toast{
      position:fixed; right:16px; bottom:16px; background:#333; color:#fff;
      padding:12px 14px; border-radius:14px; display:none; font-weight:800
    }

    /* ===== ページ間ナビ（既存と同調） ===== */
    .topnav{
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:flex-end; align-items:center; margin-bottom:8px;
    }
    .navbtn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:8px 12px;
      border-radius:999px; border:2px solid var(--ring);
      background:#fff; color:var(--ink); text-decoration:none;
      font-weight:900; font-size:14px; line-height:1;
      min-height:40px;
      box-shadow:0 4px 10px rgba(0,0,0,.06);
      transition:transform .04s ease-in, background .12s ease-in;
      touch-action: manipulation; -webkit-user-select:none; user-select:none;
    }
    .navbtn:active{ transform:translateY(1px) }
    .navbtn.primary{ background:var(--accent); color:#fff; border-color:transparent; }
    .navbtn.ghost{ background:#fff; }
    .navbtn.current{
      background:#f4f0ea; border-color:var(--ring);
      cursor:default; box-shadow:none;
    }

    /* ===== ステータス表示 ===== */
    .stat-grid{
      display:grid; grid-template-columns:1fr 1fr; gap:12px;
    }
    @media (max-width:520px){ .stat-grid{ grid-template-columns:1fr; } }

    .stat{
      display:flex; flex-direction:column; gap:6px;
      background:#fff; border:3px solid var(--ring); border-radius:18px; padding:14px;
      box-shadow:0 8px 20px rgba(0,0,0,.06);
    }
    .stat-label{ font-weight:900; color:var(--muted) }
    .stat-value{ font-weight:900; font-size:40px; line-height:1; letter-spacing:.5px }
    .yen{ font-feature-settings:"palt" 1; }

    /* 単価入力 */
    .price-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .price-input{
      width:140px; padding:10px 12px; border-radius:12px; border:2px solid var(--ring);
      font-weight:900; background:#fff; box-shadow:0 4px 10px rgba(0,0,0,.05);
      touch-action: manipulation; -webkit-user-select:none; user-select:none;
    }

    /* ===== 完了注文リスト ===== */
    .section-title{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .order-list{ display:grid; gap:12px; margin-top:8px; }
    .order{
      background:#fff; border:2px solid var(--ring); border-radius:16px; padding:12px;
      display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center;
    }
    .order-main{ display:flex; flex-wrap:wrap; gap:10px 14px; align-items:baseline }
    .time{ font-weight:900; }
    .items{ display:flex; flex-wrap:wrap; gap:10px 12px; }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px; border:2px solid var(--ring); background:#fff; font-weight:900;
    }
    .qty{ font-weight:900; }
    .empty{
      border:2px dashed var(--ring); background:#fff; color:var(--muted);
      padding:18px; border-radius:16px; text-align:center; font-weight:800;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:8px 12px; border-radius:999px; border:2px solid var(--ring);
      background:#fff; font-weight:900;
    }
    /* 整理券バッジ（濃いオレンジ×白文字） */
    .ticket-chip{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 12px; border-radius:12px; border:2px solid transparent;
      font-weight:900; font-size:16px; line-height:1; letter-spacing:.2px;
      background:var(--accent); color:#fff;
      box-shadow:0 4px 12px rgba(255,145,77,.35);
    }
    .status-chip{
      padding:6px 10px; border-radius:999px; font-weight:900;
      background:#fff; border:2px solid var(--ring); color:var(--muted);
    }

    .note{font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- ナビ -->
    <nav class="topnav" aria-label="ページ移動">
      <a class="navbtn ghost"   href="../index.html">ホーム</a>
      <a class="navbtn ghost"   href="../kitchen/">調理場</a>
      <a class="navbtn ghost"   href="../reception/">受付</a>
      <span class="navbtn current" aria-current="page">売上管理</span>
    </nav>

    <h1>売上管理</h1>

    <!-- 集計カード -->
    <section class="card" aria-labelledby="sum-title">
      <h2 id="sum-title">完了注文の集計</h2>

      <div class="price-row" style="margin-bottom:10px">
        <label for="unitPrice" class="muted" style="font-weight:900">単価</label>
        <input id="unitPrice" class="price-input" type="number" inputmode="numeric" min="0" step="10" value="400" aria-label="単価（円）">
        <span class="muted">円 / 1枚</span>
      </div>

      <div class="stat-grid" role="group" aria-label="売上集計">
        <div class="stat" aria-live="polite">
          <div class="stat-label">合計個数（完了）</div>
          <div id="totalCount" class="stat-value">0</div>
        </div>
        <div class="stat" aria-live="polite">
          <div class="stat-label">合計売上</div>
          <div id="totalRevenue" class="stat-value yen">¥0</div>
        </div>
      </div>

      <p id="last" class="muted stamp" style="margin-top:10px"></p>
      <p class="note">
        ※「受付」ページで「完了」にした注文だけが一覧に表示・集計されます。<br>
        ※ 単価はここで変更できます（リロードで初期値に戻ります）。
      </p>
    </section>

    <!-- 完了注文リスト -->
    <section class="card" aria-labelledby="list-title">
      <div class="section-title">
        <h2 id="list-title">完了済みの注文一覧</h2>
        <span class="badge">件数: <b id="doneCount">0</b></span>
      </div>
      <div id="doneList" class="order-list"></div>
      <div id="doneEmpty" class="empty" style="display:none">完了済みの注文はまだありません</div>
    </section>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

  <script>
  // ダブルタップズーム抑止（ピンチは可）
  (function preventDoubleTapZoom(){
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(e){
      const now = Date.now();
      if (now - lastTouchEnd <= 300) e.preventDefault();
      lastTouchEnd = now;
    }, { passive:false });
  })();

  document.addEventListener('DOMContentLoaded', () => {
    const $ = (id) => document.getElementById(id);
    const last = $('last');
    const toast = $('toast');
    const totalCountEl = $('totalCount');
    const totalRevenueEl = $('totalRevenue');
    const unitPriceInput = $('unitPrice');

    // 完了リスト用
    const doneList = $('doneList');
    const doneEmpty = $('doneEmpty');
    const doneCount = $('doneCount');

    const showToast = (msg) => {
      toast.textContent = msg; toast.style.display = 'block';
      setTimeout(()=> toast.style.display = 'none', 1200);
    };

    const formatJPY = (n) => Number(n || 0).toLocaleString('ja-JP', { style:'currency', currency:'JPY', maximumFractionDigits:0 });
    const formatTime = (ms) => {
      if(!ms) return '—';
      const d = new Date(ms);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      const ss = String(d.getSeconds()).padStart(2,'0');
      return `${y}/${m}/${dd} ${hh}:${mm}:${ss}`;
    };

    // Firebase 初期化
    let db;
    try{
      if (!window.firebase) throw new Error('firebase SDKがロードされていません。/__/firebase/app-compat.js を確認してください。');
      if (!firebase.apps.length) throw new Error('Firebase Appが初期化されていません。init.jsの読み込みを確認してください。');
      if (typeof firebase.database !== 'function') throw new Error('firebase.database() が使えません（database-compatが読み込まれていない）');
      db = firebase.database();
    }catch(err){
      console.error('[Firebase初期化エラー]', err);
      alert('Firebaseの初期化に失敗しました。\n' + (err.message || err));
      return;
    }

    // 集計 & リスト用のメモリ
    const doneCountMap = new Map(); // id -> count(number)（集計用）
    const doneMem = new Map();      // id -> data（表示用）

    const getCount = (data) => {
      const c = Number(data && data.count);
      return Number.isFinite(c) && c > 0 ? c : 0;
    };

    const renderTotals = () => {
      const count = Array.from(doneCountMap.values()).reduce((a,b)=>a+b, 0);
      totalCountEl.textContent = count;
      const unit = Math.max(0, Number(unitPriceInput.value)||0);
      totalRevenueEl.textContent = formatJPY(count * unit);
      last.textContent = `最終更新: ${new Date().toLocaleString('ja-JP')}`;
    };

    const orderEl = (o) => {
      const el = document.createElement('div');
      el.className = 'order';

      const left = document.createElement('div');
      left.className = 'order-main';

      // 整理券（あれば表示）
      if (o.ticketNo != null) {
        const chip = document.createElement('span');
        chip.className = 'ticket-chip';
        chip.textContent = `${o.ticketNo}`;
        left.append(chip);
      }

      // 完了時刻 or 作成時刻
      const time = document.createElement('span');
      time.className = 'time stamp';
      time.textContent = formatTime(o.completedAt || o.createdAt);
      left.append(time);

      // 品目と個数（今回はお好み焼き固定）
      const itemsBox = document.createElement('div');
      itemsBox.className = 'items';
      const pill = document.createElement('span');
      pill.className = 'pill';
      const nm = document.createElement('span'); nm.textContent = o.item || 'お好み焼き';
      const q  = document.createElement('span'); q.className = 'qty'; q.textContent = `×${o.count ?? '-'}`;
      pill.append(nm, q);
      itemsBox.appendChild(pill);
      left.append(itemsBox);

      const right = document.createElement('div');
      const st = document.createElement('span');
      st.className = 'status-chip';
      st.textContent = '完了';
      right.appendChild(st);

      el.append(left, right);
      return el;
    };

    const renderList = () => {
      const arr = Array.from(doneMem.values());
      // 古い順（completedAt優先、無ければcreatedAt）
      arr.sort((a,b)=> ((a.completedAt??a.createdAt??0) - (b.completedAt??b.createdAt??0)));
      doneList.innerHTML = '';
      arr.forEach(o => doneList.appendChild(orderEl(o)));
      doneCount.textContent = arr.length;
      doneEmpty.style.display = arr.length ? 'none' : 'block';
    };

    // リスナー
    let ref = null;
    let attached = false;

    const onAdded = (snap) => {
      const id = snap.key;
      const val = snap.val() || {};
      // 集計
      doneCountMap.set(id, getCount(val));
      // 表示データ
      doneMem.set(id, {
        item: val.item || 'お好み焼き',
        count: getCount(val),
        ticketNo: (val.ticketNo ?? null),
        status: 'done',
        createdAt: val.createdAt || 0,
        completedAt: val.completedAt || 0
      });
      renderTotals();
      renderList();
    };
    const onChanged = (snap) => {
      const id = snap.key;
      const val = snap.val() || {};
      // このクエリは done 固定なので、done→done の更新のみ
      doneCountMap.set(id, getCount(val));
      doneMem.set(id, {
        item: val.item || 'お好み焼き',
        count: getCount(val),
        ticketNo: (val.ticketNo ?? null),
        status: 'done',
        createdAt: val.createdAt || 0,
        completedAt: val.completedAt || 0
      });
      renderTotals();
      renderList();
    };
    const onRemoved = (snap) => {
      const id = snap.key;
      doneCountMap.delete(id);
      doneMem.delete(id);
      renderTotals();
      renderList();
    };

    const attach = () => {
      if (attached) return;
      // status == "done" のみを監視
      ref = db.ref('okonomiOrders').orderByChild('status').equalTo('done');

      ref.on('child_added', onAdded);
      ref.on('child_changed', onChanged);
      ref.on('child_removed', onRemoved);
      attached = true;
    };

    const detach = () => {
      if (ref) ref.off();
      attached = false;
    };

    function goActive(){ firebase.database().goOnline(); attach(); }
    function goIdle(){ detach(); firebase.database().goOffline(); }

    // 可視状態で接続制御
    if (document.hidden) goIdle(); else goActive();
    document.addEventListener('visibilitychange', () => { if (document.hidden) goIdle(); else goActive(); });
    window.addEventListener('pagehide', goIdle);
    window.addEventListener('beforeunload', goIdle);

    // 単価が変わったら再計算
    unitPriceInput.addEventListener('input', renderTotals);

    // 初期描画
    renderTotals();
    renderList();
  });
  </script>
</body>
</html>
