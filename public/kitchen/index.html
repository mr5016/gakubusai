<!DOCTYPE html>
</svg>
受付 <span id="conn" class="badge">接続中...</span>
</h1>


<div class="row"><input id="name" placeholder="お名前（呼び出しに便利）"></div>


<div class="items" id="menu-list">
<div class="line">
<select class="item">
<option>お好み焼き(豚)</option>
<option>お好み焼き(いか)</option>
<option>焼きそば</option>
<option>ドリンク</option>
</select>
<input class="qty" type="number" min="1" value="1">
<input class="note" placeholder="備考（辛め、マヨ少なめ 等）">
</div>
</div>


<div class="row" style="justify-content:space-between">
<button id="add" class="btn sec" type="button">＋ 行を追加</button>
<button id="submit" class="btn" type="button">注文を登録</button>
</div>
</div>
</div>


<script src="/app/shared.js"></script>
<script>
const connEl = document.getElementById('conn');
bindConnectionBadge(connEl);


document.getElementById('add').onclick = () => {
const row = document.querySelector('#menu-list .line').cloneNode(true);
row.querySelector('.qty').value = 1; row.querySelector('.note').value = '';
document.getElementById('menu-list').appendChild(row);
};


async function collectForm(){
const name = document.getElementById('name').value.trim();
const rows = Array.from(document.querySelectorAll('#menu-list .line'));
const menu = rows.map(r=>({
item: r.querySelector('.item').value,
qty: parseInt(r.querySelector('.qty').value || '0',10),
note: r.querySelector('.note').value.trim()
})).filter(x=>x.qty>0);
if(menu.length===0) throw new Error('品目がありません');
return { name, menu };
}


let sending = false;
document.getElementById('submit').onclick = async () => {
if(sending) return; sending = true;
const btn = document.getElementById('submit');
btn.disabled = true; btn.textContent = '送信中...';


try{
const { name, menu } = await collectForm();
const orderNo = await allocateOrderNo();
const ordersRef = firebase.database().ref('orders');
const newRef = ordersRef.push();
await newRef.set({
orderNo,
name,
menu,
status: 'new',
createdAt: serverTimestamp(),
updatedAt: serverTimestamp()
});
toast(`注文 #${orderNo} を登録しました`);
document.getElementById('name').value='';
document.querySelectorAll('#menu-list .line').forEach((r,i)=>{ if(i>0) r.remove(); });
}catch(err){
console.error(err); toast(err.message||'保存に失敗しました', false);
}finally{
sending = false; btn.disabled=false; btn.textContent='注文を登録';
}
};
</script>
</body>
</html>