<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>調理場 | 学部祭</title>
  <script defer src="/__/firebase/12.4.0/firebase-app-compat.js"></script>
  <script defer src="/__/firebase/12.4.0/firebase-auth-compat.js"></script>
  <script defer src="/__/firebase/12.4.0/firebase-firestore-compat.js"></script>
  <script defer src="/__/firebase/init.js?useEmulator=true"></script>

  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fff7ed; --paper:#ffffff; --ink:#3f2817; --muted:#8b5e34;
      --accent:#fb923c; --accent-strong:#f97316; --ring:#fdba74; --soft:#ffedd5;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:24px; color:var(--ink);
      font-family:"M PLUS Rounded 1c", system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP","Yu Gothic",Meiryo,sans-serif;
      background:radial-gradient(900px 520px at 0% -10%, #ffe7c7 0%, rgba(255,231,199,0) 60%), var(--bg);
    }
    .wrap{max-width:900px; margin:0 auto}
    .head{display:flex; align-items:center; justify-content:space-between; margin-bottom:16px}
    a{color:var(--accent-strong); font-weight:800; text-decoration:none} a:hover{text-decoration:underline}
    .title{display:flex; align-items:center; gap:10px}
    .title h1{margin:0; font-size:clamp(22px,3.2vw,34px)}
    .okonomi{width:48px;height:48px}
    .card{background:#fff; border:2px solid var(--ring); border-radius:24px; padding:18px; box-shadow:0 14px 42px rgba(249,115,22,.12)}
    .big{font-size:48px; font-weight:800; margin:0}
    .muted{color:var(--muted); font-size:13px}
    .list{margin-top:12px}
    .item{
      padding:10px 12px; border:2px solid var(--ring); border-radius:14px; background:#fffdf9;
      display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <div class="title">
        <svg class="okonomi" viewBox="0 0 120 120" aria-hidden="true">
          <ellipse cx="60" cy="70" rx="48" ry="26" fill="#b5651d"/>
          <ellipse cx="60" cy="66" rx="50" ry="28" fill="#d09a58"/>
          <ellipse cx="60" cy="60" rx="44" ry="22" fill="#5a2a13"/>
          <path d="M20,54 C38,49 44,67 60,62 C76,57 82,75 100,70" fill="none" stroke="#fff7df" stroke-width="6"/>
          <circle cx="46" cy="58" r="2" fill="#2f6b3a"/><circle cx="70" cy="62" r="2" fill="#2f6b3a"/><circle cx="84" cy="56" r="2" fill="#2f6b3a"/>
          <path d="M30,52 q6,-6 12,0 q-6,6 -12,0Z" fill="#ffe6c7" opacity=".8"/>
        </svg>
        <h1>🍳 調理場</h1>
      </div>
      <div><a href="/">← 管理ポータル</a></div>
    </div>

    <div class="card" role="region" aria-label="注文合計">
      <p class="muted">受付から登録されたお好み焼きの<strong>合計個数</strong>を表示します（キャンセル除外）。</p>
      <p class="big" id="total">0</p>
    </div>

    <div class="card" style="margin-top:12px" role="region" aria-label="最新の注文">
      <p class="muted">最新の注文（20件まで）</p>
      <div id="list" class="list" aria-live="polite"></div>
    </div>
  </div>

  <script>
    const totalEl = document.getElementById('total');
    const listEl = document.getElementById('list');

    // 全注文を監視して合計を算出（status !== "canceled"）
    firebase.firestore().collection('orders')
      .where('status','!=','canceled') // 注意: これだけだと不等号クエリの仕様上 index が必要になる場合あり
      .orderBy('status')               // Firestore の制約に合わせて orderBy を追加
      .onSnapshot(snap => {
        let total = 0;
        snap.forEach(doc => { const d = doc.data(); total += Number(d.qty||0); });
        totalEl.textContent = total;
      }, err => {
        // where('status','!=','canceled')がつらい環境では全件→クライアントで除外に切替
        console.warn('Query with status != canceled may need an index. Falling back.', err);
        firebase.firestore().collection('orders')
          .orderBy('createdAt','desc')
          .onSnapshot(s2=>{
            let total=0;
            s2.forEach(doc=>{ const d=doc.data(); if(d.status!=='canceled') total+=Number(d.qty||0); });
            totalEl.textContent = total;
          });
      });

    // 最新20件をリスト表示
    firebase.firestore().collection('orders')
      .orderBy('createdAt','desc').limit(20)
      .onSnapshot(snap=>{
        listEl.innerHTML = snap.docs.map(d=>{
          const x=d.data();
          const t=x.createdAt?.toDate?.() || new Date();
          return `<div class="item"><span>🍽️ ${x.qty} 個</span><span class="muted">${t.toLocaleString()}</span></div>`;
        }).join('');
      });
  </script>
</body>
</html>
